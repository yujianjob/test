@{
    //ViewBag.Title = "用户中心";
}

<div class="page-content inset order-confirm">
    <div class="row">
        <div class="col-md-7 col-md-offset-1">
            <form class="form-horizontal" role="form">
                <div class="form-group">
                    <label for="" class="col-sm-2 control-label">用户名</label>
                    <div class="col-sm-10">
                        <input id="txtUserName" type="text" class="form-control" value="@ViewBag.LoginName">
                        <p id="msgUserName" class="help-block"></p>
                    </div>
                </div>
                @*<div class="form-group">
                    <label for="" class="col-sm-2 control-label">昵称</label>
                    <div class="col-sm-10">
                        <input id="txtNickName" type="hidden" class="form-control" value="@ViewBag.NickName" maxlength="20">
                        <p id="msgNickName" class="help-block"></p>
                    </div>
                </div>*@
                <input id="txtNickName" type="hidden" class="form-control" value="@ViewBag.NickName" maxlength="20">

                <!--改绑手机功能移到专门页面 update by yfyang 20141031 -->
                @*<div class="form-group">
                    <label for="" class="col-xs-12 col-sm-2 control-label">手机号</label>                 
                    <div class="col-xs-8 col-sm-7" style="padding-right:0px">
                        <input id="txtMPNo" type="text" class="form-control" value="@ViewBag.MPNo" style="border-radius:25px 0 0 25px" maxlength="11">
                        <p id="msgMPNo" class="help-block"></p>
                    </div>
                    <div class="col-xs-4 col-sm-3" style="padding-left:0px">
                        <button id="btnSmsCode" name="btnSmsCode" class="btn getVerifycode-btn" type="button" style="width:100%" onclick="VerifyMobile()">获取验证码</button>
                        <p id="msgVCode" class="help-block"></p>
                    </div>
                </div>
                <div class="form-group">
                    <label for="" class="col-sm-2 control-label">验证码</label>
                    <div class="col-sm-10">
                        <input id="txtVCode" type="text" class="form-control" value="" maxlength="6">
                        <p id="msgVCode2" class="help-block"></p>
                    </div>
                </div>*@


                <div class="form-group">
                    <label for="" class="col-xs-12 col-sm-2 control-label">手机号</label>
                    @{
                        if (!string.IsNullOrEmpty(ViewBag.MPNo))
                        {
                            <div class="col-xs-8 col-sm-7" style="padding-right:0px">
                                <input id="txtMPNo" type="text" class="form-control" value="@ViewBag.MPNo" style="border-radius:25px 0 0 25px" maxlength="11" readonly="readonly">
                                <p id="msgMPNo" class="help-block"></p>
                            </div>
                            <div class="col-xs-4 col-sm-3" style="padding-left:0px">
                                <button id="btnModifyMpno" name="btnModifyMpno" class="btn modifyMpno-btn" type="button" style="width:100%" onclick="window.location.href = '/Member/MobileModify'">改绑手机号</button>
                                <p id="msgVCode" class="help-block"></p>
                            </div>
                        }
                        else
                        { 
                            <div class="col-xs-8 col-sm-7" style="padding-right:0px">
                                <input id="txtMPNo" type="hidden" class="form-control" value="@ViewBag.MPNo" style="border-radius:25px 0 0 25px" maxlength="11" readonly="readonly">
                                <p id="msgMPNo" class="help-block"></p>
                            </div>
                            <div class="col-sm-10">
                                <button class="btn Recharge" type="button" onclick="window.location.href = '/Member/MobileModify'">绑定手机号</button> 
                            </div>
                        }
                    }
                </div>

                
                <div class="form-group">
                    <label for="" class="col-sm-2 control-label">邮箱</label>
                    <div class="col-sm-10">
                        <input id="txtEmail" type="text" class="form-control" value="@ViewBag.Email" maxlength="30">
                        <p id="msgEmail" class="help-block"></p>
                    </div>
                </div>
                <div class="form-group">
                    @*<label for="" class="col-sm-2 control-label" style="padding-top:0px">余额</label>*@
                    @*<div class="col-sm-10 currency">
                        ￥@ViewBag.Money
                    </div>*@

                    <label for="" class="col-xs-12 col-sm-2 control-label" style="padding-top:0px; line-height:48px">余额</label>
                    <div class="col-xs-12 col-sm-10" style="padding-left:0">
                        <div class="col-xs-3 col-sm-3 currency" style="line-height:48px">
                            ￥@ViewBag.Money
                        </div>
                        <div class="col-xs-9  col-sm-9">
                            <button id="rechargeCard" class="btn Recharge" type="button" onclick="showRechargeBox(event);">充值</button>
                        </div>
                        <div style="clear:both"></div>
                        <div class="rechargeRel" style="display:none">
                            <div class="arrow"></div>
                            <div class="recharge_cont">
                                <p>
                                    <span class="help-block" style="padding-bottom: 10px; padding-top:10px; overflow:hidden">充值卡卡密不区分大小写</span>
                                    <input type="text" id="pw1" name="pw1" onkeyup="FuncCheckPass(this)" style="width:16%"> -
                                    <input type="text" id="pw2" name="pw2" onkeyup="FuncCheckPass(this)" style="width:16%"> -
                                    <input type="text" id="pw3" name="pw3" onkeyup="FuncCheckPass(this)" style="width:16%"> -
                                    <input type="text" id="pw4" name="pw4" onkeyup="FuncCheckPass(this)" style="width:16%">
                                    <button type="button" class="btn Recharge pull-right" style="width:20%;" onclick="FuncBindRechargeCard(event);">充值</button>
                                </p>

                            </div>
                        </div>


                    </div>



                    
                </div>
                <div class="form-group">
                    <div class="col-sm-offset-2 col-sm-10">
                        <p id="msgInfo" class="help-block" style="text-align:right"></p>
                        <button type="button" class="btn btn-danger btn-lg pull-right save-btn">保存</button>
                    </div>
                </div>
            </form>

        </div>
    </div>
</div>
@section scripts
{
    <script type="text/javascript">
        var OldMPNo = "@ViewBag.MPNo";
        var checkSmsCode = false;
        var timer = null;

        $(function () {
            $(".save-btn").click(function () {
                if (Check()) {
                    //改绑手机功能移到专门页面 update by yfyang 20141031
                    //var postData = { "txtLoginName": txtUserName.value.trim(), "txtNickName": txtNickName.value, "txtMPNo": txtMPNo.value, "txtEmail": txtEmail.value, "txtVCode": txtVCode.value };
                    var postData = { "txtLoginName": txtUserName.value.trim(), "txtNickName": txtNickName.value, "txtMPNo": txtMPNo.value, "txtEmail": txtEmail.value };
                    $.ajax({
                        type: "post",
                        url: "@Url.Action("User_UpdateInfo", "Member")",
                        data: postData,
                        dataType: "json",
                        success: function (resultJson) {
                            if (resultJson.Code == 1) {
                                showPopDiv("用户信息更新成功！", true);
                            }
                            else {
                                showPopDiv(resultJson.Msg);
                            }
                        },
                        error: function (msg) {
                            alert(msg.responseText.toString());
                        }
                    });
                }
            });
        });

        function Check() {
            $("#msgUserName").html("");
            $("#msgNickName").html("");
            $("#msgMPNo").html("");
            $("#msgEmail").html("");

            //改绑手机功能移到专门页面 update by yfyang 20141031
            //$("#msgVCode").html("");
            //$("#msgVCode2").html("");

            $("#msgInfo").html("");


            if (!$("#txtUserName").val().match("^[a-zA-Z][0-9a-zA-Z_]{3,29}$")) {
            //if (!txtUserName.value.match("^[a-zA-Z][0-9a-zA-Z_]{3,29}$")) {
                $("#msgUserName").html("请输入以字母开头4-30位英文、数字登录名。");
                $("#txtUserName").focus();
                //txtUserName.focus();
                return false;
            }

            if ($("#txtNickName").val().trim().length < 2) {
            //if (txtNickName.value.trim().length < 2) {
                $("#msgNickName").html("昵称必须大于2个字符");
                $("#txtNickName").focus();
                //txtNickName.focus();
                return false;
            }

            if (!$("#txtNickName").val().trim().match("^[\u4E00-\u9FA5A-Za-z0-9 _]+$")) {
            //if (!txtNickName.value.trim().match("^[\u4E00-\u9FA5A-Za-z0-9 _]+$")) {
                $("#msgNickName").html("昵称格式错误，请重新输入");
                $("#txtNickName").focus();
                //txtNickName.focus();
                return false;
            }

            //改绑手机功能移到专门页面 update by yfyang 20141031
            //if (CheckMobile(txtMPNo, msgMPNo).code == 0) {
            //    txtMPNo.focus();
            //    return false;
            //}

            //if (OldMPNo != txtMPNo.value.trim()) {
            //    if (!checkSmsCode) {
            //        $("#msgMPNo").html("请验证手机号！");
            //        return false;
            //    }
            //    else {
            //        if (!txtVCode.value.match("^[0-9]{6}$")) {
            //            $("#msgVCode2").html("请输入6位验证码。");
            //            txtVCode.focus();
            //            return false;
            //        }
            //    }
            //}

            //if (txtEmail.value.trim() != "") {
            //    if (CheckEmail(txtEmail, msgEmail).code == 0) {
            //        txtEmail.focus();
            //        return false;
            //    }
            //}
            if ($("#txtEmail").val().trim() != "") {
                if (CheckEmail($("#txtEmail"), $("#msgEmail")).code == 0) {
                    $("#txtEmail").focus();
                    return false;
                }
            }
            return true;
        }

        function VerifyMobile() {
            if (timer != null)
                return;

            if (CheckMobile(txtMPNo, msgMPNo).code == 0) {
                txtMPNo.focus();
                return false;
            }
            $("#msgMPNo").html("");

            if (OldMPNo == txtMPNo.value.trim())
                return false;
            
            var postData = { "mpno": txtMPNo.value.trim() };

            $.ajax({
                type: "post",
                url: "@Url.Action("VerifyMobile", "Member")",
                data: postData,
                dataType: "json",
                success: function (resultJson) {
                    if (resultJson.Code == 1) {
                        $("#msgVCode").html("验证码已经发送成功");
                        checkSmsCode = true;
                        daojishi();
                    }
                    else {
                        $("#msgMPNo").html(resultJson.Msg);
                    }
                },
                error: function (msg) {
                    alert(msg.toString());
                }
            });
        }

        function daojishi() {
            var i = 60;
            if (!timer) {
                $("#btnSmsCode").text(i);
                timer = setInterval(function () {
                    i--;
                    $("#btnSmsCode").text(i);
                    if (i == -1) {
                        clearInterval(timer);
                        timer = null;
                        $("#btnSmsCode").text("获取验证码");
                    }
                }, 1000);
            }
        }


        function FuncCheckPass(obj) {
            if (!obj.value.match("^[0-9a-fA-F]{1,4}$"))
                obj.value = obj.value.substr(0, obj.value.length - 1).toUpperCase();
            else
                obj.value = obj.value.toUpperCase();
            if (obj.value.length == 4) {
                switch (obj.name) {
                    case "pw1":
                        $("#pw2").focus();//pw2.focus();
                        break;
                    case "pw2":
                        $("#pw3").focus();//pw3.focus();
                        break;
                    case "pw3":
                        $("#pw4").focus();//pw4.focus();
                        break;
                }
            }
        }

        function FuncBindRechargeCard(event) {
            event.stopPropagation();

            //if (pw1.value.length != 4) {
            //    pw1.focus();
            //    return false;
            //}

            //if (pw2.value.length != 4) {
            //    pw2.focus();
            //    return false;
            //}

            //if (pw3.value.length != 4) {
            //    pw3.focus();
            //    return false;
            //}

            //if (pw4.value.length != 4) {
            //    pw4.focus();
            //    return false;
            //}
            if ($("#pw1").val().length != 4) {
                $("#pw1").focus();
                return false;
            }
            if ($("#pw2").val().length != 4) {
                $("#pw2").focus();
                return false;
            }
            if ($("#pw3").val().length != 4) {
                $("#pw3").focus();
                return false;
            }
            if ($("#pw4").val().length != 4) {
                $("#pw4").focus();
                return false;
            }

            //var sPass = pw1.value + pw2.value + pw3.value + pw4.value;
            var sPass = $("#pw1").val() + $("#pw2").val() + $("#pw3").val() + $("#pw4").val();
            var postData = { "cardPass": sPass, "cardType": 2 };

            $.ajax({
                type: "post",
                url: "@Url.Action("User_BindCard", "Member")",
                data: postData,
                dataType: "json",
                success: ProcessCardBind,
                error: function (msg) {
                    showPopDiv(msg.toString(), false);
                }
            });

        }

        function ProcessCardBind(resultJson) {
            if (resultJson != null) {
                if (resultJson.Code == 1) {
                    //pw1.value = ""; pw2.value = ""; pw3.value = ""; pw4.value = "";
                    $("#pw1").val("");
                    $("#pw2").val("");
                    $("#pw3").val("");
                    $("#pw4").val("");
                    showPopDiv(resultJson.Msg, true);
                }
                else {
                    showPopDiv(resultJson.Msg, false);
                }
            }
        }

        $("html,body").scrollTop(0);
        function showRechargeBox(event) {
            event.stopPropagation();

            $("#rechargeCard").fadeOut("fast");

            var doch = $(document).height();
            $("html,body").animate({ scrollTop: doch }, 1000);
            $(".rechargeRel").slideDown();

        }
        $(".recharge_cont").click(function (event) {
            event.stopPropagation();
        });
        $(document).click(function () {
            $(".rechargeRel").slideUp();

            $("#rechargeCard").fadeIn("fast");
        });
    </script>

}